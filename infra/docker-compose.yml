services:
  mongo:
    image: mongo:7
    restart: unless-stopped
    ports:
      - "27017:27017"

  postgres:
    image: pgvector/pgvector:pg16
    restart: unless-stopped
    environment:
      POSTGRES_DB: defra
      POSTGRES_USER: defra
      POSTGRES_PASSWORD: defra
    ports:
      - "5432:5432"
    volumes:
      - ./db-init/pgvector.sql:/docker-entrypoint-initdb.d/pgvector.sql

  neo4j:
    image: neo4j:5.13
    restart: unless-stopped
    ports:
      - "7474:7474"  # HTTP Browser interface
      - "7687:7687"  # Bolt protocol
    environment:
      NEO4J_AUTH: neo4j/defrapassword
      NEO4J_PLUGINS: '["apoc"]'
      NEO4J_dbms_security_procedures_unrestricted: apoc.*
      NEO4J_dbms_memory_heap_max__size: 2G
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs

  agent:
    build:
      context: ..
      dockerfile: infra/Dockerfile.agent
    env_file:
      - ../.env
    environment:
      MONGO_URI: mongodb://mongo:27017
      PG_DSN: dbname=defra user=defra password=defra host=postgres
      NEO4J_URI: bolt://neo4j:7687
      NEO4J_USER: neo4j
      NEO4J_PASSWORD: defrapassword
      RUN_INTERVAL_HOURS: "2"  # Run every 2 hours
    depends_on:
      - mongo
      - postgres
      - neo4j
    restart: unless-stopped
    command: ["/bin/sh", "-c", "while true; do echo '\nðŸ¤– Starting agent run...' && uv run defra-agent-run && echo 'âœ… Agent run complete. Waiting 2 hours...' && sleep 7200; done"]

  mcp-ea-env:
    build:
      context: ..
      dockerfile: infra/Dockerfile.mcp_ea_env
    restart: unless-stopped

volumes:
  neo4j_data:
  neo4j_logs: